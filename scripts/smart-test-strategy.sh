#!/bin/bash
# Smart Test Strategy - WFHroulette
# Generated by create-qa-architect (Pro/Enterprise feature)
set -e

echo "ğŸ§  Analyzing changes for optimal test strategy..."

# Environment variable overrides
if [[ "$SKIP_SMART" == "1" ]]; then
  echo "âš ï¸  SKIP_SMART=1 - Running comprehensive tests"
  npm test
  exit 0
fi

if [[ "$FORCE_MINIMAL" == "1" ]]; then
  echo "âšª FORCE_MINIMAL=1 - Running lint only"
  npm run lint && npm run format:check
  exit 0
fi

# Collect metrics
CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD 2>/dev/null | wc -l | tr -d ' ')
CHANGED_LINES=$(git diff --stat HEAD~1..HEAD 2>/dev/null | tail -1 | grep -o '[0-9]* insertions' | grep -o '[0-9]*' || echo "0")
CURRENT_BRANCH=$(git branch --show-current)
HOUR=$(date +%H)
DAY_OF_WEEK=$(date +%u)

# Project-specific high-risk patterns (CLI Tool)
HIGH_RISK_FILES=$(git diff --name-only HEAD~1..HEAD 2>/dev/null | grep -E "src/|lib/|cli" || true)
CONFIG_FILES=$(git diff --name-only HEAD~1..HEAD 2>/dev/null | grep -E "(package\.json|\.env|config)" || true)
TEST_FILES=$(git diff --name-only HEAD~1..HEAD 2>/dev/null | grep -E "test/" || true)

# Calculate risk score (0-10)
RISK_SCORE=0

[[ -n "$HIGH_RISK_FILES" ]] && RISK_SCORE=$((RISK_SCORE + 4))
[[ -n "$CONFIG_FILES" ]] && RISK_SCORE=$((RISK_SCORE + 2))
[[ $CHANGED_FILES -gt 10 ]] && RISK_SCORE=$((RISK_SCORE + 2))
[[ $CHANGED_LINES -gt 200 ]] && RISK_SCORE=$((RISK_SCORE + 2))

case $CURRENT_BRANCH in
  main|master|production) RISK_SCORE=$((RISK_SCORE + 3)) ;;
  hotfix/*) RISK_SCORE=$((RISK_SCORE + 4)) ;;
esac

HOUR_NUM=$((10#$HOUR))
if [[ $HOUR_NUM -ge 9 && $HOUR_NUM -le 17 && $DAY_OF_WEEK -le 5 ]]; then
  echo "â° Work hours - Optimizing for speed"
  SPEED_BONUS=true
else
  SPEED_BONUS=false
fi

echo ""
echo "ğŸ“Š Analysis Results:"
echo "   ğŸ“ Files changed: $CHANGED_FILES"
echo "   ğŸ“ Lines changed: $CHANGED_LINES"
echo "   ğŸŒ¿ Branch: $CURRENT_BRANCH"
echo "   ğŸ¯ Risk Score: $RISK_SCORE/10"
echo "   âš¡ Speed Bonus: $SPEED_BONUS"
echo ""

if [[ $RISK_SCORE -ge 6 ]]; then
  echo "ğŸ”´ HIGH RISK - Full validation"
  echo "   â€¢ Unit + integration tests"
  npm test
elif [[ $RISK_SCORE -ge 3 ]]; then
  echo "ğŸŸ¡ MEDIUM RISK - Unit tests"
  npm run test:unit
elif [[ $RISK_SCORE -ge 2 || "$SPEED_BONUS" == "false" ]]; then
  echo "ğŸŸ¢ LOW RISK - Lint only"
  npm run lint && npm run format:check
else
  echo "âšª MINIMAL RISK - Quick check"
  npm run format:check
fi

echo ""
echo "ğŸ’¡ Tip: Run 'npm test' locally for full validation"
echo "ğŸ’ Smart Test Strategy powered by create-qa-architect Pro"
